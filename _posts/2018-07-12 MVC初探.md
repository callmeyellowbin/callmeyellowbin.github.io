---
layout:     post
title:      MVC初探
#subtitle:   学习对象初始化
date:      2018-07-12
author:     Hoben Wong
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - iOS
    - Objective-C
    - 设计模式之旅
---
###一.概念
MVC：模型-视图-控制器，是最古老、最成功的可复用软件设计模式之一。MVC定义了Cocoa框架的总体结构，是一种高级别的模式，能将多个写作对象的大型群组划分为独立的子系统：模型、视图和控制器。

在面向对象的应用程序中，信息不只是字节，对象会将信息与使用该信息的方法封装在一起。应用程序中的每个对象都应该符合且仅符合以下子系统之一：

- 模型：模型子系统由为应用程序提供`独特功能`和`信息存储`的对象组成，包含处理应用程序数据的所有规则。保证模型子系统的独立而不依赖于视图或者控制器子系统非常关键。

- 视图：视图子系统用于`展示`从模型中收集的信息，并为用户提供与此信息`交互`的方式。理解视图的关键是要知道总是有大量的视图存在。例如，可能有图形用户界面视图、打印报表视图、命令行视图、基于Web的视图、脚本语言视图，它们都与同一个模型交互。

- 控制器：控制器的目的是解除模型和视图之间的耦合。用户和视图的交互的结果是向控制器子系统发出请求，还可能进一步请求模型中的信息。控制器还要处理数据的转换和格式，以呈现给用户。

例如，在我们实现一个滑块功能的时候，有以下步骤：
1. 用户与滑块（`视图`）进行交互，并发出一条消息给`控制器`
2. `控制器`识别出要根据新的值更新的`模型对象`，发送消息给`模型对象`，请求更新。
3. `模型对象`对更新消息作出反应，将更新值限定到程序所定义的范围之内，或执行其他验证。应用程序逻辑已经应用了更新值，其他模型对象可能受到影响也随之更新。然后`模型`通知`控制器`：我已经更改完毕。
4. `控制器`给`视图对象`发送消息，使`视图`反映`模型`的变化，`视图`的很多部分可能都会更新。

![MVC示例](https://upload-images.jianshu.io/upload_images/8407639-2c36a9a9503e5c44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

###二.Cocoa的MVC
####1.概念
核心数据在`模型`里面，应用程序工具箱包含在`视图`和`控制器子系统`里面，基本框架包含在`这三个子系统`中使用的类。基本框架并不直接提供任何具体的视图或者控制器部件，它所提供的是使用操作系统服务的权限、基于NSObject的类、脚本支持，以及其他一些在模型、视图和控制器使用的功能。
####2.模型子系统的核心数据支持
Cocoa的核心数据技术能够辅助模型子系统开发，并解决了两个常见的实现问题：持续的信息存储和对象关系管理。

核心数据使用`对象持久性`的计数来加载和存储信息，基本的方法是存储模型本身，包括所有封装的信息和对象间的关系。核心数据能以三种文件格式来加载和存储持久对象：可识别的XML、二进制平面文件或者SQLite数据库。

`NSManagedObject类`为对象关系管理提供了内置支持，并且与`NSManagedObjectContext`交互以提供持续存储。`NSManagedObject `提供了关联存储模式，允许在不子类化的情况下添加关系和名为属性的单个实力信息。核心数据用NSNumber、NSData、NSString和NSSet实例来存储属性。子类化能让人更好地控制属性的存储方式，可以使用自定义对象或者C语言结构作为属性。

####3.视图子系统的应用程序工具箱支持
NSMenu、NSWindow、NSApplication、NSView类构成了Cocoa的图形用户界面。Cocoa应用程序所显示的所有内容几乎都是菜单或者窗口的一部分。每个Cocoa应用程序都使用`NSApplication类`的实例来连接操作系统，以便接收用户输入的时间、在dock中显示图标、显示主菜单或显示窗口等。`NSView`的子类用于实现所有标准的用户界面元素，如构成窗口内容的按钮、文本、选项卡视图等。

NSWindow、NSApplication、NSView都是NSResponder的子类，`NSResponder`是应用程序设计箱设计中最关键的类之一，它能封装用户输入事件的处理并实现响应链，以确保事件和消息均被所描述的正确对象所接收。

NSView实现的是`层次结构模式`，可以创建包含多层视图的界面，每个视图都可以包含任意数量的子视图。

NSView里面有NSControll的子类，Cocoa的很多标准用户界面组件都是NSControll类，它在目标、操作和响应链模式中承担了重要的角色。例如，当用户通过`NSDatePicker`对象选择日期的时候，会发送操作消息到日期选择器目标。如果不存在特定的目标，最终接收该消息的对象是由响应链决定。

NSCell类实现享元模式，享元能优化`执行时间`和`内存消耗`。NSControl类的实例使用NSCell的子类以达到最优性能，并增加了灵活性。NSTableView的不同NSCell实例决定了在每列中显示数据的方式，我们不必使用NSTableView的子类来控制信息的显示方式。相反，可以使用不同的嵌入单元来配置标准的NSTableView。

####4.控制器子系统的应用程序工具箱支持
Cocoa的NSController类及其相关的类，在`视图对象`和`模型对象`之前充当`中介者`的角色，中介者控制着信息流，并在某些情况下提供默认的“占位符”值。例如，如果视图对象根据用户的当前选择来显示数据，那么在没有选择任何数据时，中介者能提供默认的数据供使用。

应用程序工具箱提供NSController、NSObjectController、NSArrayController、NSUserDefaultsController和NSTreeController等类，它们可以使用Cocoa的`绑定技术`来干预数据流。绑定可以通过程序或者Interface Builder在对象间建立关系。如果存在绑定，运行时对于每个绑定对象的修改都会导致其他绑定对象的自动更新。

除了协调模型和视图间的数据流以外，控制器子系统还负责应用程序行为的总体控制。当存在多个视图子系统时，控制器子系统中的对象负责确定要把哪个视图呈献给用户。

####5.Cocoa的文本架构
NSText和NSTextView类为Cocoa的MVC文本架构提供用户可见的部分（`视图`），NSTextStorage类为`模型`提供存储和处理文本的功能。

NSLayoutManager类用作视图和模型之间的`控制器`协调，每个NSTextView实例均请求关联的NSLayoutManager实例来提供要显示的文本。反过来，NSLayoutManager访问NSTextStorage和NSTextContainer的实例以提供要显示的文本。

在良好的MVC样式中，NSTextStorage不依赖文本显示，很多文本处理任务在`模型`子系统中都是可能的。例如更文本属性、修改和搜索文本、通过网络将文本显示为Web页面。
